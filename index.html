<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>2025 학생부종합(강원권) 입시결과 분석</title>
<link rel="stylesheet" href="style.css">
<script src="xlsx.full.min.js"></script>
</head>

<body>

<header class="top-header">
  <div class="header-inner">
    <h1>2025 학생부종합전형 입시결과 분석</h1>
    <p class="subtitle">
      강원권 · 환산등급(R열) · 합격결과(U열) · 산포도 비교
    </p>
  </div>
</header>

<section class="filter-card">
  <div class="filter-group">
    <label>엑셀 업로드</label>
    <input type="file" id="excelInput" accept=".xlsx,.xls">
  </div>

  <div class="filter-group">
    <label>지역</label>
    <select id="selRegion"></select>
  </div>

  <div class="filter-group">
    <label>대학명</label>
    <select id="selUniv"></select>
  </div>

  <div class="filter-group">
    <label>세부유형</label>
    <select id="selDetail"></select>
  </div>

  <div class="filter-group">
    <label>모집단위(단일)</label>
    <select id="selMajor"></select>
  </div>
</section>

<section class="main-layout">
  <!-- 좌측: 모집단위 컷 -->
  <aside class="side-panel">
    <h2>모집단위별 컷(최대 5개 비교)</h2>

    <table class="cut-table">
      <thead>
        <tr>
          <th>모집단위</th>
          <th>50%</th>
          <th>70%</th>
          <th>N</th>
        </tr>
      </thead>
      <tbody id="cutBody"></tbody>
    </table>

    <div class="table-guide">
      ▸ 행 클릭: 비교 선택 (최대 5개)<br>
      ▸ 다시 클릭: 선택 해제<br>
      ▸ 상단 드롭박스 선택 시 비교 초기화
    </div>
  </aside>

  <!-- 우측: 산포도 -->
  <section class="chart-panel">
    <div class="legend">
      <span class="leg pass">● 합격</span>
      <span class="leg add">▲ 충원합격</span>
      <span class="leg fail">✖ 불합격</span>
    </div>

    <canvas id="cv" width="1200" height="560"></canvas>

    <p class="chart-note">
      ※ 환산등급은 연속 축(등급 사이 소수 포함)으로 표시됩니다.
    </p>
  </section>
</section>

<script>
/* ===============================
   컬럼 인덱스 (고교명 미사용)
================================ */
const COL = {
  REGION:4, UNIV:5, TYPE:7, DETAIL:9,
  MAJOR:11, GRADE:17, RESULT:20
};
const TYPE_OK = "학생부위주(종합)";
const MAX_COMPARE = 5;

let rows = [], filtered = [], majorsOrder = [];
let activeMajors = new Set();

const $ = id => document.getElementById(id);
const ctx = $("cv").getContext("2d");

/* 유틸 */
const v = x => (x ?? "").toString().trim();
const n = x => Number(v(x));
const uniq = a => [...new Set(a.filter(v=>v))];

/* 드롭박스 */
function setOptions(sel, list){
  sel.innerHTML = `<option value="">전체</option>`;
  uniq(list).forEach(x=>{
    const o=document.createElement("option");
    o.value=o.textContent=x;
    sel.appendChild(o);
  });
}

/* 엑셀 로드 */
$("excelInput").onchange = e => {
  const r = new FileReader();
  r.onload = ev => {
    const wb = XLSX.read(ev.target.result,{type:"array"});
    const sh = wb.Sheets[wb.SheetNames[0]];
    const aoa = XLSX.utils.sheet_to_json(sh,{header:1,defval:""});
    rows = aoa.slice(1).filter(r=>v(r[COL.TYPE])===TYPE_OK);
    init();
  };
  r.readAsArrayBuffer(e.target.files[0]);
};

function init(){
  setOptions(selRegion, rows.map(r=>r[COL.REGION]));
  setOptions(selUniv, rows.map(r=>r[COL.UNIV]));
  setOptions(selDetail, rows.map(r=>r[COL.DETAIL]));
  setOptions(selMajor, rows.map(r=>r[COL.MAJOR]));
  refresh();
}

/* 필터 */
function refresh(){
  filtered = rows.filter(r =>
    (!selRegion.value || v(r[COL.REGION])===selRegion.value) &&
    (!selUniv.value   || v(r[COL.UNIV])===selUniv.value) &&
    (!selDetail.value || v(r[COL.DETAIL])===selDetail.value)
  );
  buildTable();
  draw();
}

/* 분위수 */
function quant(a,q){
  if(!a.length) return NaN;
  const i=(a.length-1)*q;
  const lo=Math.floor(i), hi=Math.ceil(i);
  return lo===hi?a[lo]:a[lo]*(1-(i-lo))+a[hi]*(i-lo);
}

/* 테이블 */
function buildTable(){
  const map=new Map();
  filtered.forEach(r=>{
    const m=v(r[COL.MAJOR]), g=n(r[COL.GRADE]);
    if(!m||isNaN(g)) return;
    if(!map.has(m)) map.set(m,[]);
    map.get(m).push(g);
  });

  const body=$("cutBody");
  body.innerHTML="";
  majorsOrder=[...map.keys()];

  majorsOrder.forEach(m=>{
    const arr=map.get(m).sort((a,b)=>a-b);
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${m}</td>
      <td>${quant(arr,.5).toFixed(2)}</td>
      <td>${quant(arr,.7).toFixed(2)}</td>
      <td>${arr.length}</td>`;

    tr.onclick=()=>{
      if(activeMajors.has(m)){
        activeMajors.delete(m);
        tr.classList.remove("active");
      }else{
        if(activeMajors.size>=MAX_COMPARE){
          alert("모집단위 비교는 최대 5개까지 가능합니다.");
          return;
        }
        activeMajors.add(m);
        tr.classList.add("active");
      }
      draw();
    };
    body.appendChild(tr);
  });
}

/* 산포도 */
function draw(){
  ctx.clearRect(0,0,1200,560);

  const padL=50,padR=40,padT=30,padB=50;
  const w=1200-padL-padR,h=560-padT-padB;

  ctx.strokeStyle="#d7eadf";
  ctx.fillStyle="#1f3d2b";

  for(let g=1;g<=9;g++){
    const x=padL+(g-1)/8*w;
    ctx.beginPath();ctx.moveTo(x,padT);ctx.lineTo(x,padT+h);ctx.stroke();
    ctx.fillText(g+"등급",x-12,padT+h+20);
  }

  const majors = activeMajors.size ? [...activeMajors] :
                 (selMajor.value ? [selMajor.value] : majorsOrder);
  const rowH=h/Math.max(1,majors.length);

  filtered.forEach(r=>{
    const m=v(r[COL.MAJOR]);
    if(!majors.includes(m)) return;

    const g=n(r[COL.GRADE]);
    if(isNaN(g)) return;

    const x=padL+(g-1)/8*w;
    const y=padT+majors.indexOf(m)*rowH+rowH/2;

    const res=v(r[COL.RESULT]);
    ctx.lineWidth=2;

    if(res.includes("충원")){
      ctx.strokeStyle="#f0a500";
      ctx.beginPath();
      ctx.moveTo(x,y-8);ctx.lineTo(x-8,y+8);ctx.lineTo(x+8,y+8);
      ctx.closePath();ctx.stroke();
    }else if(res.includes("합격")){
      ctx.fillStyle="#1b8a5a";
      ctx.beginPath();ctx.arc(x,y,7,0,Math.PI*2);ctx.fill();
    }else{
      ctx.strokeStyle="#c62828";
      ctx.beginPath();
      ctx.moveTo(x-7,y-7);ctx.lineTo(x+7,y+7);
      ctx.moveTo(x+7,y-7);ctx.lineTo(x-7,y+7);
      ctx.stroke();
    }
  });
}

/* 이벤트 */
["selRegion","selUniv","selDetail","selMajor"].forEach(id=>{
  $(id).onchange=()=>{
    activeMajors.clear();
    document.querySelectorAll(".cut-table tr").forEach(tr=>tr.classList.remove("active"));
    refresh();
  };
});
</script>

</body>
</html>
