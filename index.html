<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>학생부종합 산포도 분석</title>
<link rel="stylesheet" href="style.css">
<script src="xlsx.full.min.js"></script>
</head>
<body>

<header class="top-header">
  <h1>학생부종합전형 입시결과 산포도 분석</h1>
  <p>환산등급(R열) · 합격결과(U열) · 모집단위 비교</p>
</header>

<section class="toolbar">
  <input type="file" id="excelInput" accept=".xlsx,.xls">

  <select id="selRegion"></select>
  <select id="selUniv"></select>
  <select id="selDetail"></select>
  <select id="selMajor"></select>

  <div class="result-filter">
    <button class="on" data-type="합격">합격</button>
    <button class="on" data-type="충원">충원합격</button>
    <button class="on" data-type="불">불합격</button>
  </div>

  <button onclick="savePNG()">PNG</button>
  <button onclick="savePDF()">PDF</button>
</section>

<section class="layout">
  <aside class="side">
    <h2>모집단위별 컷</h2>
    <table>
      <thead>
        <tr><th>모집단위</th><th>50%</th><th>70%</th><th>N</th></tr>
      </thead>
      <tbody id="cutBody"></tbody>
    </table>
    <p class="hint">행 클릭: 비교 / Hover: 강조 (최대 5개)</p>
  </aside>

  <section class="chart">
    <canvas id="cv" width="1200" height="560"></canvas>
    <div class="legend">
      <span class="pass">● 합격</span>
      <span class="add">▲ 충원합격</span>
      <span class="fail">✖ 불합격</span>
    </div>
  </section>
</section>

<script>
/* ================= 설정 ================= */
const COL={REGION:4,UNIV:5,TYPE:7,DETAIL:9,MAJOR:11,GRADE:17,RESULT:20};
const TYPE_OK="학생부위주(종합)";
const MAX_COMPARE=5;

let rows=[], filtered=[];
let activeMajors=new Set(), hoverMajor=null;
let show={합격:true,충원:true,불:true};

const $=id=>document.getElementById(id);
const ctx=$("cv").getContext("2d");

/* 유틸 */
const v=x=>(x??"").toString().trim();
const n=x=>Number(v(x));
const uniq=a=>[...new Set(a.filter(Boolean))];

/* ================= 엑셀 ================= */
excelInput.onchange=e=>{
  const r=new FileReader();
  r.onload=ev=>{
    const wb=XLSX.read(ev.target.result,{type:"array"});
    const sh=wb.Sheets[wb.SheetNames[0]];
    const aoa=XLSX.utils.sheet_to_json(sh,{header:1,defval:""});
    rows=aoa.slice(1).filter(r=>v(r[COL.TYPE])===TYPE_OK);
    init();
  };
  r.readAsArrayBuffer(e.target.files[0]);
};

/* ================= UI ================= */
function setOptions(sel,list){
  sel.innerHTML=`<option value="">전체</option>`;
  uniq(list).forEach(x=>{
    const o=document.createElement("option");
    o.value=o.textContent=x;
    sel.appendChild(o);
  });
}

function init(){
  setOptions(selRegion,rows.map(r=>r[COL.REGION]));
  setOptions(selUniv,rows.map(r=>r[COL.UNIV]));
  setOptions(selDetail,rows.map(r=>r[COL.DETAIL]));
  setOptions(selMajor,rows.map(r=>r[COL.MAJOR]));
  refresh();
}

/* ================= 필터 ================= */
function refresh(){
  filtered=rows.filter(r=>
    (!selRegion.value||v(r[COL.REGION])===selRegion.value) &&
    (!selUniv.value||v(r[COL.UNIV])===selUniv.value) &&
    (!selDetail.value||v(r[COL.DETAIL])===selDetail.value) &&
    (!selMajor.value||v(r[COL.MAJOR])===selMajor.value)
  );
  buildTable();
  draw();
}

/* ================= 컷 ================= */
function quant(a,q){
  if(!a.length)return NaN;
  const i=(a.length-1)*q,lo=Math.floor(i),hi=Math.ceil(i);
  return lo===hi?a[lo]:a[lo]*(1-(i-lo))+a[hi]*(i-lo);
}

function buildTable(){
  const map=new Map();
  filtered.forEach(r=>{
    const m=v(r[COL.MAJOR]),g=n(r[COL.GRADE]);
    if(!m||isNaN(g))return;
    if(!map.has(m))map.set(m,[]);
    map.get(m).push(g);
  });

  cutBody.innerHTML="";
  map.forEach((arr,m)=>{
    arr.sort((a,b)=>a-b);
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${m}</td><td>${quant(arr,.5).toFixed(2)}</td><td>${quant(arr,.7).toFixed(2)}</td><td>${arr.length}</td>`;
    tr.onclick=()=>{
      if(activeMajors.has(m)){activeMajors.delete(m);tr.classList.remove("active");}
      else{
        if(activeMajors.size>=MAX_COMPARE){alert("최대 5개");return;}
        activeMajors.add(m);tr.classList.add("active");
      }
      draw();
    };
    tr.onmouseenter=()=>{hoverMajor=m;draw();}
    tr.onmouseleave=()=>{hoverMajor=null;draw();}
    cutBody.appendChild(tr);
  });
}

/* ================= 산포도 ================= */
function draw(){
  ctx.clearRect(0,0,1200,560);

  const padL=60,padR=40,padT=40,padB=50;
  const w=1200-padL-padR,h=560-padT-padB;

  /* 등급선 */
  for(let g=1;g<=9;g++){
    const x=padL+(g-1)/8*w;
    ctx.strokeStyle=g===1||g===2?"#0b6b3a":"#aacfb7";
    ctx.lineWidth=g<=3?2:1;
    ctx.beginPath();ctx.moveTo(x,padT);ctx.lineTo(x,padT+h);ctx.stroke();
    ctx.fillStyle="#0b6b3a";
    ctx.font="bold 13px Arial";
    ctx.fillText(g+"등급",x-14,padT+h+20);
  }

  /* 컷선 */
  const grades=filtered.map(r=>n(r[COL.GRADE])).filter(v=>!isNaN(v)).sort((a,b)=>a-b);
  const c50=quant(grades,.5), c70=quant(grades,.7);
  drawCut(c50,"#1b8a5a"); drawCut(c70,"#f0a500");

  const majors=activeMajors.size?[...activeMajors]:uniq(filtered.map(r=>r[COL.MAJOR]));
  const rowH=h/Math.max(1,majors.length);

  filtered.forEach((r,i)=>{
    const m=v(r[COL.MAJOR]);
    if(!majors.includes(m))return;

    const res=v(r[COL.RESULT]);
    if((res.includes("합격")&&!show.합격)||(res.includes("충원")&&!show.충원)||(res.includes("불")&&!show.불))return;

    const g=n(r[COL.GRADE]);
    if(isNaN(g))return;

    const x=padL+(g-1)/8*w;
    let y=padT+majors.indexOf(m)*rowH+rowH/2;
    y+=(i%5-2)*2;

    const emph=(m===hoverMajor);
    ctx.lineWidth=emph?3:2;

    if(res.includes("충원")){
      ctx.strokeStyle="#f0a500";
      ctx.beginPath();
      ctx.moveTo(x,y-9);ctx.lineTo(x-9,y+9);ctx.lineTo(x+9,y+9);
      ctx.closePath();ctx.stroke();
    }else if(res.includes("합격")){
      ctx.fillStyle="#1b8a5a";
      ctx.beginPath();ctx.arc(x,y,emph?8:6,0,Math.PI*2);ctx.fill();
    }else{
      ctx.strokeStyle="#c62828";
      ctx.beginPath();
      ctx.moveTo(x-8,y-8);ctx.lineTo(x+8,y+8);
      ctx.moveTo(x+8,y-8);ctx.lineTo(x-8,y+8);
      ctx.stroke();
    }
  });
}

function drawCut(v,color){
  if(isNaN(v))return;
  const x=60+(v-1)/8*(1200-100);
  ctx.setLineDash([6,4]);
  ctx.strokeStyle=color;
  ctx.beginPath();ctx.moveTo(x,40);ctx.lineTo(x,510);ctx.stroke();
  ctx.setLineDash([]);
}

/* ================= 버튼 ================= */
document.querySelectorAll(".result-filter button").forEach(b=>{
  b.onclick=()=>{
    b.classList.toggle("on");
    show[b.dataset.type]=b.classList.contains("on");
    draw();
  };
});

["selRegion","selUniv","selDetail","selMajor"].forEach(id=>{
  $(id).onchange=()=>{activeMajors.clear();refresh();};
});

/* 저장 */
function savePNG(){
  const a=document.createElement("a");
  a.href=$("cv").toDataURL();
  a.download="scatter.png";a.click();
}
function savePDF(){window.print();}
</script>
</body>
</html>
