<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>학생부종합 산포도 (강원권)</title>
<link rel="stylesheet" href="style.css">
<script src="xlsx.full.min.js"></script>
</head>
<body>

<header>
  <h2>2025 학생부종합(강원권) 입시결과 산포도</h2>
</header>

<section class="controls">
  <input type="file" id="excelInput" accept=".xlsx,.xls">

  <select id="selRegion"></select>
  <select id="selUniv"></select>
  <select id="selDetail"></select>
  <select id="selMajor"></select>
</section>

<section class="layout">
  <div class="tableWrap">
    <h3>모집단위별 컷</h3>
    <table>
      <thead>
        <tr>
          <th>모집단위</th>
          <th>50%</th>
          <th>70%</th>
          <th>N</th>
        </tr>
      </thead>
      <tbody id="cutBody"></tbody>
    </table>
    <p class="hint">※ 행 클릭 → 산포도 표시 / 다시 클릭 → 해제 (다중 선택 가능)</p>
  </div>

  <div class="chartWrap">
    <canvas id="cv" width="1100" height="520"></canvas>
    <div class="legend">
      <span class="l pass">● 합격</span>
      <span class="l add">▲ 충원합격</span>
      <span class="l fail">✖ 불합격</span>
      <span class="l cut50">― 50%</span>
      <span class="l cut70">― 70%</span>
    </div>
  </div>
</section>

<script>
/* ===== 엑셀 열 고정 ===== */
const COL = {
  REGION:4, UNIV:5, TYPE:7, DETAIL:9, MAJOR:11, GRADE:17, RESULT:20
};
const TYPE_OK = "학생부위주(종합)";

let rows = [];
let filtered = [];
let majorsOrder = [];
let activeMajors = new Set();

const $ = id => document.getElementById(id);
const ctx = $("cv").getContext("2d");

/* ===== 유틸 ===== */
const v = x => (x??"").toString().trim();
const n = x => Number(v(x));
const uniq = arr => [...new Set(arr.filter(v=>v))];

/* ===== 드롭박스 ===== */
function setOptions(sel, list){
  sel.innerHTML = `<option value="">전체</option>`;
  uniq(list).forEach(x=>{
    const o=document.createElement("option");
    o.value=o.textContent=x;
    sel.appendChild(o);
  });
}

/* ===== 엑셀 로드 ===== */
$("excelInput").onchange = e => {
  const r = new FileReader();
  r.onload = ev => {
    const wb = XLSX.read(ev.target.result,{type:"array"});
    const sh = wb.Sheets[wb.SheetNames[0]];
    const aoa = XLSX.utils.sheet_to_json(sh,{header:1,defval:""});
    rows = aoa.slice(1).filter(r=>v(r[COL.TYPE])===TYPE_OK);
    init();
  };
  r.readAsArrayBuffer(e.target.files[0]);
};

function init(){
  setOptions(selRegion, rows.map(r=>r[COL.REGION]));
  setOptions(selUniv, rows.map(r=>r[COL.UNIV]));
  setOptions(selDetail, rows.map(r=>r[COL.DETAIL]));
  setOptions(selMajor, rows.map(r=>r[COL.MAJOR]));
  refresh();
}

/* ===== 필터 ===== */
function refresh(){
  filtered = rows.filter(r =>
    (!selRegion.value || v(r[COL.REGION])===selRegion.value) &&
    (!selUniv.value   || v(r[COL.UNIV])===selUniv.value) &&
    (!selDetail.value || v(r[COL.DETAIL])===selDetail.value)
  );
  buildTable();
  draw();
}

/* ===== 컷 계산 ===== */
function quant(arr,q){
  if(!arr.length) return NaN;
  const i=(arr.length-1)*q;
  const lo=Math.floor(i), hi=Math.ceil(i);
  return lo===hi?arr[lo]:arr[lo]*(1-(i-lo))+arr[hi]*(i-lo);
}

/* ===== 테이블 ===== */
function buildTable(){
  const map=new Map();
  filtered.forEach(r=>{
    const m=v(r[COL.MAJOR]);
    const g=n(r[COL.GRADE]);
    if(!m||isNaN(g)) return;
    if(!map.has(m)) map.set(m,[]);
    map.get(m).push(g);
  });

  const body=$("cutBody");
  body.innerHTML="";
  majorsOrder=[...map.keys()];

  majorsOrder.forEach(m=>{
    const arr=map.get(m).sort((a,b)=>a-b);
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${m}</td>
      <td>${quant(arr,.5).toFixed(2)}</td>
      <td>${quant(arr,.7).toFixed(2)}</td>
      <td>${arr.length}</td>`;
    tr.onclick=()=>{
      tr.classList.toggle("active");
      activeMajors.has(m)?activeMajors.delete(m):activeMajors.add(m);
      draw();
    };
    body.appendChild(tr);
  });
}

/* ===== 산포도 ===== */
function draw(){
  ctx.clearRect(0,0,1100,520);

  const padL=40,padR=30,padT=20,padB=40;
  const w=1100-padL-padR,h=520-padT-padB;

  /* grid */
  ctx.strokeStyle="#d7eadf";
  for(let g=1;g<=9;g++){
    const x=padL+(g-1)/8*w;
    ctx.beginPath();ctx.moveTo(x,padT);ctx.lineTo(x,padT+h);ctx.stroke();
    ctx.fillText(g+"등급",x-10,padT+h+18);
  }

  const majors = activeMajors.size? [...activeMajors]: majorsOrder;
  const rowH=h/Math.max(1,majors.length);

  filtered.forEach((r,i)=>{
    const m=v(r[COL.MAJOR]);
    if(activeMajors.size && !activeMajors.has(m)) return;

    const g=n(r[COL.GRADE]);
    if(isNaN(g)) return;

    const x=padL+(g-1)/8*w;
    const y=padT+majors.indexOf(m)*rowH+rowH/2;

    const res=v(r[COL.RESULT]);
    ctx.lineWidth=2;
    if(res.includes("충원")){
      ctx.strokeStyle="#f0a500";
      ctx.beginPath();
      ctx.moveTo(x,y-6);ctx.lineTo(x-6,y+6);ctx.lineTo(x+6,y+6);ctx.closePath();
      ctx.stroke();
    }else if(res.includes("합격")){
      ctx.fillStyle="#1b8a5a";
      ctx.beginPath();ctx.arc(x,y,6,0,Math.PI*2);ctx.fill();
    }else{
      ctx.strokeStyle="#c62828";
      ctx.beginPath();
      ctx.moveTo(x-6,y-6);ctx.lineTo(x+6,y+6);
      ctx.moveTo(x+6,y-6);ctx.lineTo(x-6,y+6);
      ctx.stroke();
    }
  });
}

/* ===== 이벤트 ===== */
["selRegion","selUniv","selDetail","selMajor"].forEach(id=>{
  $(id).onchange=()=>{
    activeMajors.clear();
    refresh();
  };
});
</script>
</body>
</html>
